GEMMA PIPELINE
==============

Analyze imputed genotypes from SNPTEST using GEMMA.

ISSUES
------
* GEMMA require phenotype to calculate relatedness matrix. Does this mean it needs to be recalculated for each phenotype?

PIPELINE STEPS
--------------

1. Create a phenotype file
''''''''''''''''''''''''''

Bascically, a phenotype file consists of one value per line for every individual::

 phenotype value1
 phenotype value2
 phenotype value3
 ...
 phenotype valueN

More than one row can be present, indicating multiple phenotype values per individual. Covariates can also be given in a separate file.

Please refer to the GEMMA manual for more detail on how to create a phenotype and covariate file.

2. Genotypes and Relatedness Matrix
'''''''''''''''''''''''''''''''''''

In addition to a phenotype file, GEMMA also requires genotypes in BIMBAM format (see section S1) and a relatedness matrix (see section S2).

The pipeline requires a list of informative SNPs. See section S3 for how to generate such a file.

3. Run GEMMA pipeline
'''''''''''''''''''''
Once you have all these files the pipeline is run using the run_pipeline script::

 run_pipeline.sh -m ../matrix/317k/merge.bimbam.cXX.txt \
                 -p ../pheno/pheno.txt \
		 -t ~/tempdata/ \
		 -i ~/share/vince.forgetta/0712-probabel-pipeline/static/tuk.info_0.4 \
 		 ~/share/vince.forgetta/t123TUK/imputed/1kGenomes.Phase1/bimbam/*.mgf

Where options are::

 -m    [filename]    Relatedness matrix file
 -p    [filename]    Phenotype file
 -i    [filename]    Informative SNPs file
 -t    [directory]   Temporary directory

After all options the path to the mean genotype files is provided. Wildcards are allowed.

The pipeline consists of 4 steps:

i. Run GEMMA for each genotype file (gemma binary). 
ii. Remove SNPs with low informativity, etc (clean.bash).
iii. Generate graphs for each genotype file (graphs.bash).
iv. Once all genotype files are processed, summarize results for the entire dataset (results.bash).

4. Pipeline Output
''''''''''''''''''

Summary results of the GEMMA analysis are:

4.1 Association results
:::::::::::::::::::::::

Within the \"output\" directory there are \*.assoc.txt and \*.assoc.txt.clean files, containg GEMMA results for all SNPs and filtered SNPs, respectively.

4.2 Manhattan plot
::::::::::::::::::

A Manhattan plot is generated for each genotype file as well as for the entire dataset.

3.3 QQ-plot
:::::::::::

A QQ plot is generated for each genotype file as well as for the entire dataset.

4.4 Box plots
:::::::::::::

Box plots for Beta and SE are generated for each genotype file as well as for the entire dataset.

4.5 Top SNPs table
::::::::::::::::::

TDB

SUPPLEMENTARY STEPS
-------------------

S1 Convert SNPTEST to BIMBAM format
'''''''''''''''''''''''''''''''''''

To convert SNPTEST to BIMBAM format::

 bin/gen2bimbam_batch.bash ~/archive/t123TUK/imputed/1kGenomes.Phase1/gen.sample/chr/*.gen

Resulging mean genotype files are in::

 ~/share/vince.forgetta/t123TUK/imputed/1kGenomes.Phase1/bimbam/

Generate annotation files for GEMMA::

 bin/bimbam2annotate.bash ~/share/vince.forgetta/t123TUK/imputed/1kGenomes.Phase1/bimbam/*.mgf

S2 Compute relatedness matrix
'''''''''''''''''''''''''''''
Generated by Houfeng Zheng, common genotyped SNPs from 317k and 610k for t123::

 ~/share/tuk317k_allsamples/

For steps below, are in::

 ~/share/vince.forgetta/0812-gemma-pipeline/matrix/317k

I merged all chromosomes into one file using plink::

 plink --merge-list merge_list.txt --noweb --out merge --ped tuk317k_allsamples_chr10.ped \
       --map tuk317k_allsamples_chr10.map --recode --nonfounders

Used gtool to convert to SNPTEST format::

 gtool -P --ped merge.ped --map merge.map  --og merge.gen --os merge.sample

Convert SNPTEST format to BIMBAM format::

 bin/gen2bimbam_batch.bash merge.gen

Generate relatedness matrix using gemma::

 gemma -g matrix/317k/merge.mgf -p pheno/pheno.txt -gk 2 -o merge.317k

Matrix is for this dataset is in::

 ~/share/vince.forgetta/0812-gemma-pipeline/matrix/317k/merge.bimbam.cXX.txt

S3 SNP informativity file
'''''''''''''''''''''''''

To filter for informative SNPs a list of SNPs with informativity >= 0.4 was generated as follows::


 # Files with informativity information
 INFO_FILES=`ls ~/archive/t123TUK/imputed/1kGenomes.Phase1/info/info_posterior_tuk*.b37ph\
 /*.b37ph.chr1-22.ALL_1000G_phase1interim_jun2011_.posterior_sampled_haps_imputation.impute2_info`
 
 # Min. allele freq to include SNP from informativity files
 INFO_MIN_FREQ=0.4
 
 # Where informative SNPs are stored
 INFO_SNP_FILE=~/share/vince.forgetta/0712-probabel-pipeline/static/tuk.info_${INFO_MIN_FREQ}

 tail -q -n +2 $INFO_FILES | awk "{ if (\$5 >= ${INFO_MIN_FREQ}){ if (\$1 ~ /\-\-\-/){ split(\$2, a, \"-\"); \
 print \$2, a[1], \$3 }else{ print \$2, \$1, \$3 }}}" | sort -k1,1 -T ${TMPDIR} | uniq -d > ${INFO_SNP_FILE}
